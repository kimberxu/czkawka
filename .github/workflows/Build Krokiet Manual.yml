name: Build Krokiet Manual

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-all:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      # 1. 恢复缓存 (策略升级：模糊匹配)
      - name: Restore Cache
        id: restore-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          # 1. 优先尝试找“当前 Commit”的缓存 (几乎不可能命中，除非你Retry)
          key: ${{ runner.os }}-cargo-gui-${{ hashFiles('**/Cargo.lock') }}-${{ github.sha }}
          # 2. 【关键】找不到当前 Commit，就找“基于这个 Cargo.lock”的最近一次缓存
          # 这样就能把上一次(哪怕是失败的)构建产物拉下来
          restore-keys: |
            ${{ runner.os }}-cargo-gui-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-cargo-core-

      # 2. 编译 Core
      - name: Build Core
        run: cargo build --release -p czkawka_core

      # 3. 编译 GUI (允许失败)
      - name: Build Krokiet (GUI)
        id: build-gui
        continue-on-error: true
        run: cargo build --release --bin krokiet --no-default-features --features "winit_skia_opengl,winit_software"

      # 4. 保存 GUI 缓存 (策略升级：唯一 Key)
      # 【关键修改】：Key 末尾加上了 github.sha
      # 这样每次你提交代码/修改代码，Key 都是新的，绝对不会报 "Unable to reserve"
      - name: Save GUI Cache
        if: always() # 只要到了这一步就尝试保存，不管前面是否命中
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          # 使用 Commit SHA 确保 Key 唯一，避免冲突
          key: ${{ runner.os }}-cargo-gui-${{ hashFiles('**/Cargo.lock') }}-${{ github.sha }}

      # 5. 检查构建状态并报错
      - name: Check Build Status
        if: steps.build-gui.outcome != 'success'
        run: |
          echo "::error::GUI Build failed! check the logs above."
          echo "Cache has been saved with SHA suffix to speed up next run."
          exit 1

      # 6. 上传产物
      - uses: actions/upload-artifact@v4
        if: steps.build-gui.outcome == 'success'
        with:
          name: Krokiet_Build_${{ github.sha }}
          path: target/release/krokiet.exe
