import { Button, CheckBox, LineEdit, ScrollView, StandardListView, VerticalBox, HorizontalBox, TabWidget } from "std-widgets.slint";
import { ColorPalette } from "color_palette.slint";
import { GuiState } from "gui_state.slint";
import { Callabler } from "callabler.slint";
import { AdvancedSelectionCriterion } from "common.slint";
import { Translations } from "translations.slint";

export component PopupAdvancedSelection inherits Rectangle {
    callback show_popup();
    callback close_popup();
    
    // in-out property <bool> visible: false; // Removed as it overrides base property
    in-out property <length> popup_width: 500px;
    in-out property <length> popup_height: 500px;

    in-out property <[AdvancedSelectionCriterion]> criteria: [
        { name: Translations.advanced_select_criteria_mod_date, enabled: false, ascending: true, id: 0 },
        { name: Translations.advanced_select_criteria_creation_date, enabled: false, ascending: true, id: 1 },
        { name: Translations.advanced_select_criteria_size, enabled: false, ascending: true, id: 2 },
        { name: Translations.advanced_select_criteria_filename_len, enabled: false, ascending: true, id: 3 },
        { name: Translations.advanced_select_criteria_path_len, enabled: false, ascending: true, id: 4 },
    ];
    
    in-out property <string> directory_path;
    in-out property <bool> include_subdirs: true;

    // Overlay background
    width: 100%;
    height: 100%;
    background: #00000080; // Semi-transparent dim
    visible: false;

    // Block clicks on overlay from passing through
    TouchArea {}

    Rectangle {
        width: root.popup_width;
        height: root.popup_height;
        background: ColorPalette.popup_background;
        border-radius: 5px;
        border-width: 1px;
        border-color: ColorPalette.text_color;

        // Block clicks on content from passing through
        TouchArea {}

        VerticalBox {
            padding: 10px;
            spacing: 10px;

            Text {
                text: Translations.advanced_select_title;
                font-size: 16px;
                horizontal-alignment: center;
            }

            TabWidget {
                Tab {
                    title: Translations.advanced_select_group_tab;
                    VerticalBox {
                        Text { text: Translations.advanced_select_group_criteria; }
                        
                        for criterion[idx] in criteria : HorizontalLayout {
                            spacing: 10px;
                            CheckBox {
                                text: criterion.name;
                                checked: root.criteria[idx].enabled;
                                toggled => {
                                    root.criteria[idx].enabled = self.checked;
                                }
                            }
                            Button {
                                text: criterion.ascending ? 
                                    (criterion.id == 0 || criterion.id == 1 ? Translations.advanced_select_date_asc :
                                     criterion.id == 2 ? Translations.advanced_select_size_asc :
                                     criterion.id == 3 || criterion.id == 4 ? Translations.advanced_select_len_asc : 
                                     Translations.advanced_select_asc)
                                    : 
                                    (criterion.id == 0 || criterion.id == 1 ? Translations.advanced_select_date_desc :
                                     criterion.id == 2 ? Translations.advanced_select_size_desc :
                                     criterion.id == 3 || criterion.id == 4 ? Translations.advanced_select_len_desc : 
                                     Translations.advanced_select_desc);
                                clicked => {
                                    criterion.ascending = !criterion.ascending;
                                }
                            }
                            Button {

                                text: "↑";
                                enabled: idx > 0;
                                clicked => {
                                    let temp = root.criteria[idx - 1];
                                    root.criteria[idx - 1] = root.criteria[idx];
                                    root.criteria[idx] = temp;
                                }
                            }
                            Button {
                                text: "↓";
                                enabled: idx < root.criteria.length - 1;
                                clicked => {
                                    let temp = root.criteria[idx + 1];
                                    root.criteria[idx + 1] = root.criteria[idx];
                                    root.criteria[idx] = temp;
                                }
                            }
                        }
                        
                        HorizontalLayout {
                            spacing: 10px;
                            // Buttons moved to bottom
                        }

                        Button {
                            text: Translations.advanced_select_button_select;
                            clicked => {
                                Callabler.select_advanced_group(root.criteria);
                                // root.close_popup(); // Keep open
                            }
                        }

                    }
                }
                Tab {
                    title: Translations.advanced_select_directory_tab;
                    VerticalBox {
                        Text { text: Translations.advanced_select_directory_path; }
                        LineEdit {
                            text <=> root.directory_path;
                            placeholder-text: Translations.advanced_select_directory_placeholder;
                        }
                        CheckBox {
                            text: Translations.advanced_select_include_subdirs;
                            checked <=> root.include_subdirs;
                        }
                        
                        HorizontalLayout {
                            spacing: 10px;
                            Button {
                                text: Translations.advanced_select_btn_other;
                                clicked => {
                                    Callabler.select_advanced_custom_path(root.directory_path, root.include_subdirs, 1); // 1 = select other
                                    root.close_popup();
                                }
                            }
                            Button {
                                text: Translations.advanced_select_btn_this;
                                clicked => {
                                    Callabler.select_advanced_custom_path(root.directory_path, root.include_subdirs, 0); // 0 = select this
                                    root.close_popup();
                                }
                            }
                        }
                        HorizontalLayout {
                            spacing: 10px;
                            Button {
                                text: "Uncheck Other"; // TODO: Translation
                                clicked => {
                                    Callabler.select_advanced_custom_path(root.directory_path, root.include_subdirs, 3); // 3 = uncheck other
                                    root.close_popup();
                                }
                            }
                            Button {
                                text: "Uncheck This"; // TODO: Translation
                                clicked => {
                                    Callabler.select_advanced_custom_path(root.directory_path, root.include_subdirs, 2); // 2 = uncheck this
                                    root.close_popup();
                                }
                            }
                        }
                    }
                }
            }
            
            HorizontalLayout {
                spacing: 10px;
                Button {
                    text: Translations.selection_deselect_all_text;
                    clicked => { Callabler.reset_selection(GuiState.active_tab); }
                }
                Button {
                    text: Translations.selection_invert_selection_text;
                    clicked => { Callabler.row_reverse_checked_selection(); }
                }
            }

            Button {
                text: Translations.advanced_select_close;
                clicked => { root.close_popup(); }
            }
        }
    }

    show_popup() => {
        root.visible = true;
    }
    close_popup() => {
        root.visible = false;
    }
}
